<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script type="text/javascript" src="underscore-min.js"></script>
		<style>
			
			body {
				background: #000;
			}

			#follower{
			  position : absolute;
			  background-color : #cff;
			  color : #000;
			  padding : 10px;
			}

			.shot {
				background: #f00;
			}

			#rocket-count {
				background: #f00;
			}

			.enemy {
				position: absolute;
				background: #0f0;
			}

		</style>
	</head>
	<body>
		
		<div id="follower">
			SPACESHIP<br />
			rockets: <span id="rocket-count">1</span><br />
			killz: <span id="kill-count">0</span><br />
		</div>

	</body>
	<script>

		// RA shim layer with setTimeout fallback
		(function() {
		    var lastTime = 0;
		    var vendors = ['webkit', 'moz'];
		    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
		        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
		        window.cancelAnimationFrame =
		          window[vendors[x]+'CancelAnimationFrame'] || window[vendors[x]+'CancelRequestAnimationFrame'];
		    }

		    if (!window.requestAnimationFrame)
		        window.requestAnimationFrame = function(callback, element) {
		            var currTime = new Date().getTime();
		            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
		            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
		              timeToCall);
		            lastTime = currTime + timeToCall;
		            return id;
		        };

		    if (!window.cancelAnimationFrame)
		        window.cancelAnimationFrame = function(id) {
		            clearTimeout(id);
		        };
		}());

		var delay = 250,
			playField = $('body'),
			updater,
			newTopPos,
			mouseY = 0,
			mouseX = 0,
			newTopCosNum = 0,
			newLeftCosNum = 0,
			newPos = { top: 0},
			xp = 0, 
			yp = 0,
			spaceShip,
			shotSpeed = 1,
			leftEdge = $(document).width()-100,
			playFieldHeight = $(document).height()-30;
			rocketTopSpeed = 25,
			enemies = {},
			uniqueEnemyCounter = 0,
			enemyGeneratorChecker = 0.9;

		function Enemy ()Â {

			var that = this;

			this.el = $('<div>').addClass('enemy').text('enemy!');
			this.enemyId = 0;
			this.newPos = { top: 0, left: 0};
			this.randCosNum = Math.floor(Math.random()*10) / 100;
			this.randCosMultiplier = Math.floor(Math.random()*2)+1;
			this.randLeftMoveSpeed = Math.floor( Math.random()*3 )+1;

			this.kill = function() {
				delete enemies[this.enemyId];
				this.el.fadeOut(250).remove();
			};

			this.moveTowardsSpaceship = function() {
				// this.newPos.top = parseInt(this.elItWantsToDestroy().css('top'));
				this.randCosNum += 0.02;
				this.newPos.right += this.randLeftMoveSpeed;
				this.newPos.top += (parseInt(this.elItWantsToDestroy().css('top')) - this.newPos.top) / delay;
				this.newPos.top = this.newPos.top + ( Math.cos(this.randCosNum) * this.randCosMultiplier );
				this.el.css({top: this.newPos.top, right: this.newPos.right + 1});
				if (this.newPos.right > leftEdge) this.kill();
			};

			this.hitBox = function() {
				var hitBox = { pos: this.el.offset(), size: { width: this.el.width(), height: this.el.height() } };
				return hitBox;
			};

			this.checkIfHitByRocket = function() {
				if (spaceShip.shotExists()) {
			    	if (spaceShip.shotHitBox().pos.left + spaceShip.shotHitBox().size.width > this.hitBox().pos.left && spaceShip.shotHitBox().pos.top + spaceShip.shotHitBox().size.height > this.hitBox().pos.top && spaceShip.shotHitBox().pos.top < this.hitBox().pos.top + this.hitBox().size.height) {
			    		spaceShip.destroyShot(); 
			    		this.kill();
			    		spaceShip.addKill();
			    	}
				}
			};

			this.checkIfHitPlayer = function() {
		    	if (spaceShip.hitBox().pos.left + spaceShip.hitBox().size.width > this.hitBox().pos.left && spaceShip.hitBox().pos.top + spaceShip.hitBox().size.height > this.hitBox().pos.top && spaceShip.hitBox().pos.top < this.hitBox().pos.top + this.hitBox().size.height) {
		    		spaceShip.kill();
		    		this.kill();
		    	}
			};

			this.elItWantsToDestroy = function() {
				if (typeof spaceShip !== 'undefined')
				return spaceShip.el;
			};

			this.createStartPos = function() {
				var topPos = Math.floor( Math.random()*playFieldHeight );
				return { top: topPos, right: 0 };
			};

			this.create = function() {
				var enemyId = uniqueEnemyCounter;

				uniqueEnemyCounter++;

				this.el.attr('id', 'enemy-'+enemyId);
				this.enemyId = enemyId;
				this.newPos = this.createStartPos();
				this.el.css( this.newPos );

				playField.append(this.el);
			};

			this.init = function() {
				this.create();
			};

			this.init();
			
		};

		var spaceShip = {
			el: $("#follower"),
			shotLeftPos: false,
			shotSpeed: shotSpeed,
			kills: 0,
			kill: function() {
				this.el.fadeOut(250).remove();
				var test = alert('You suck! But you did kill '+this.kills+' alien enemies.');
				window.location = 'index.html';
			},
			addKill: function() {
				this.kills += 1;
				$('#kill-count').text(this.kills);
			},
			move: function() {
				xp += ((mouseX/5) - xp) / delay;
			    yp += (mouseY - yp) / delay;

			    newTopCosNum = newTopCosNum+0.03;
			    newLeftCosNum = newLeftCosNum+0.012;

			    newTopPos = yp + ( Math.cos(newTopCosNum) * 50 );
			    newLeftPos = xp + ( Math.cos(newLeftCosNum) * 30 );

			    this.el.css({ left: Math.floor(newLeftPos), top: Math.floor(newTopPos) });
			},
			moveRockets: function() {

			    if (this.shotExists()) {
			    	if (!this.shotLeftPos) this.shotLeftPos = parseInt( this.getCurrentShot().css('left') );
			    	this.shotLeftPos += this.shotSpeed;
			    	if (this.shotSpeed < rocketTopSpeed) this.shotSpeed *= 1.05;
			    	if (this.shotLeftPos > leftEdge) this.destroyShot();
			    	this.getCurrentShot().css({left: this.shotLeftPos});
			    }

			},
			getCurrPos: function() {
				var topPos = $('#rocket-count').offset().top,
					leftPos = $('#rocket-count').offset().left;
				return { top: topPos, left: leftPos };
			},
			shoot: function(clickX, clickY) {
				if (this.shotExists()) return false;

				var currPos = this.getCurrPos(),
					deltaY = this.getCurrPos().top - clickY,
					deltaX = this.getCurrPos().left - clickX,
					newDiv = $('<div class="shot">').css({position: 'absolute'}).text('ROCKET').css(currPos),
					degress = Math.atan2(deltaY, deltaX) * 180 / Math.PI ;

					alert('Shoot rocket @ '+degress+' degress!');

				playField.append(newDiv);

				this.el.find('#rocket-count').text('0');

			},
			shotHitBox: function() {
				var shot = $('.shot'),
					shotHitBox = { pos: shot.offset(), size: { width: shot.width(), height: shot.height() } };
				return shotHitBox;
			},
			hitBox: function() {
				var hitBox = { pos: this.el.offset(), size: { width: this.el.width(), height: this.el.height() } };
				return hitBox;
			},
			shotExists: function() {
				return $('.shot').length > 0;
			},
			destroyShot: function() {
				$('.shot').remove();
				this.shotLeftPos = false;
				this.shotSpeed = shotSpeed;
				this.el.find('#rocket-count').text('1');
			},
			getCurrentShot: function() {
				return $('.shot');
			}
		};

		$(document).on('mousemove', function(e){
		   mouseX = e.pageX;
		   mouseY = e.pageY; 
		}).on('mousedown', function(event) {
		    switch (event.which) {
		        case 1:
		        	spaceShip.shoot(mouseX, mouseY);
		            break;
		        case 2:
		        	enemies[uniqueEnemyCounter] = new Enemy();
		        	// enemies.push( new Enemy() );
		            break;
		    }
		});

		var enemyGenerator = setInterval(function() {
			var checkAgainst = Math.random();
			if (checkAgainst > enemyGeneratorChecker) enemies[uniqueEnemyCounter] = new Enemy();
			enemyGeneratorChecker = enemyGeneratorChecker*0.99;
		}, 1000);

		function loop () {

			if (!_(enemies).isEmpty()) {
				_(enemies).each( function( enemy, key, enemies ) {
					// Move enemies
					enemy.moveTowardsSpaceship();
					// Check if hit by rockets
					enemy.checkIfHitByRocket();
					// Check if hit by player
					enemy.checkIfHitPlayer();
				});
			}

			// Move spaceship
		    spaceShip.move();

		    // Move rockets if exists
		    spaceShip.moveRockets();

		    requestAnimationFrame(loop);
		};

		requestAnimationFrame(loop);

	</script>

</html>
