<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
		<script type="text/javascript" src="underscore-min.js"></script>
		<style>
			
			body {
				background: #000;
			}

			#follower{
			  position : absolute;
			  background-color : #cff;
			  color : #000;
			  padding : 10px;
			}

			.shot {
				background: #f00;
			}

			#rocket-count {
				background: #f00;
			}

			.enemy {
				position: absolute;
				background: #0f0;
			}

		</style>
	</head>
	<body>
		
		<div id="follower">
			SPACESHIP<br />
			rockets: <span id="rocket-count">1</span>
		</div>

	</body>
	<script>

		var framerate = 60,
			delay = 250,
			framerateInMSecs = 1000/framerate,
			playField = $('body'),
			updater,
			newTopPos,
			mouseY = 0,
			mouseX = 0,
			newTopCosNum = 0,
			newLeftCosNum = 0,
			newPos = { top: 0},
			xp = 0, 
			yp = 0,
			spaceShip,
			shotSpeed = 1,
			leftEdge = $(document).width()-100,
			playFieldHeight = $(document).height()-30;
			rocketTopSpeed = 25,
			enemies = {},
			uniqueEnemyCounter = 0;

		function Enemy ()Â {

			var that = this;

			this.el = $('<div>').addClass('enemy').text('enemy!');
			this.enemyId = 0;
			this.newPos = { top: 0, left: 0};
			this.randCosNum = Math.floor(Math.random()*10) / 100;
			this.randCosMultiplier = Math.floor(Math.random()*2)+1;
			this.randLeftMoveSpeed = Math.floor( Math.random()*3 )+1;

			this.kill = function() {
				delete enemies[this.enemyId];
				this.el.fadeOut(250).remove();
			};

			this.moveTowardsSpaceship = function() {
				// this.newPos.top = parseInt(this.elItWantsToDestroy().css('top'));
				this.randCosNum += 0.02;
				this.newPos.right += this.randLeftMoveSpeed;
				this.newPos.top += (parseInt(this.elItWantsToDestroy().css('top')) - this.newPos.top) / delay;
				this.newPos.top = this.newPos.top + ( Math.cos(this.randCosNum) * this.randCosMultiplier );
				this.el.css({top: this.newPos.top, right: this.newPos.right + 1});
				if (this.newPos.right > leftEdge) this.kill();
			};

			this.hitBox = function() {
				var hitBox = { pos: this.el.offset(), size: { width: this.el.width(), height: this.el.height() } };
				return hitBox;
			};

			this.elItWantsToDestroy = function() {
				if (typeof spaceShip !== 'undefined')
				return spaceShip.el;
			};

			this.createStartPos = function() {
				var topPos = Math.floor( Math.random()*playFieldHeight );
				return { top: topPos, right: 0 };
			};

			this.create = function() {
				var enemyId = uniqueEnemyCounter;

				uniqueEnemyCounter++;

				this.el.attr('id', 'enemy-'+enemyId);
				this.enemyId = enemyId;
				this.newPos = this.createStartPos();
				this.el.css( this.newPos );

				playField.append(this.el);
			};

			this.init = function() {
				this.create();
			};

			this.init();
			
		};

		var spaceShip = {
			getCurrPos: function() {
				var topPos = $('#rocket-count').offset().top,
					leftPos = $('#rocket-count').offset().left;
				return { top: topPos, left: leftPos };
			},
			shoot: function() {
				if (this.shotExists()) return false;
				var currPos = this.getCurrPos(),
					newDiv = $('<div class="shot">').css({position: 'absolute'}).text('ROCKET').css(currPos);

				playField.append(newDiv);

				this.el.find('#rocket-count').text('0');

			},
			shotHitBox: function() {
				var shot = $('.shot'),
					shotHitBox = { pos: shot.offset(), size: { width: shot.width(), height: shot.height() } };
				return shotHitBox;
			},
			shotExists: function() {
				return $('.shot').length > 0;
			},
			destroyShot: function() {
				$('.shot').remove();
				this.shotLeftPos = false;
				this.shotSpeed = shotSpeed;
				this.el.find('#rocket-count').text('1');
			},
			getCurrentShot: function() {
				return $('.shot');
			},
			el: $("#follower"),
			shotLeftPos: false,
			shotSpeed: shotSpeed
		};

		$(document).on('mousemove', function(e){
		   mouseX = e.pageX;
		   mouseY = e.pageY; 
		}).on('mousedown', function(event) {
		    switch (event.which) {
		        case 1:
		        	spaceShip.shoot();
		            break;
		        case 2:
		        	enemies[uniqueEnemyCounter] = new Enemy();
		        	// enemies.push( new Enemy() );
		            break;
		        case 3:
		            break;
		        default:
		            alert('You have a strange mouse');
		    }
		});

		var loop = setInterval(function(){

			if (!_(enemies).isEmpty()) {
				_(enemies).each( function( enemy, key, enemies ) {
					enemy.moveTowardsSpaceship();
				});
			}

		    xp += ((mouseX/5) - xp) / delay;
		    yp += (mouseY - yp) / delay;

		    newTopCosNum = newTopCosNum+0.03;
		    newLeftCosNum = newLeftCosNum+0.012;

		    newTopPos = yp + ( Math.cos(newTopCosNum) * 50 );
		    newLeftPos = xp + ( Math.cos(newLeftCosNum) * 30 );

		    if (spaceShip.shotExists()) {
		    	if (!spaceShip.shotLeftPos) spaceShip.shotLeftPos = parseInt( spaceShip.getCurrentShot().css('left') );
		    	spaceShip.shotLeftPos += spaceShip.shotSpeed;
		    	if (spaceShip.shotSpeed < rocketTopSpeed) spaceShip.shotSpeed *= 1.05;
		    	// if (spaceShip.shotHitBox().pos.left + spaceShip.shotHitBox().size.width > enemies[0].hitBox().pos.left && spaceShip.shotHitBox().pos.top + spaceShip.shotHitBox().size.height > enemies[0].hitBox().pos.top && spaceShip.shotHitBox().pos.top < enemies[0].hitBox().pos.top + enemies[0].hitBox().size.height) {
		    	// 	spaceShip.destroyShot(); enemies[0].kill();
		    	// }
		    	if (spaceShip.shotLeftPos > leftEdge) spaceShip.destroyShot();
		    	spaceShip.getCurrentShot().css({left: spaceShip.shotLeftPos});
		    }

		    spaceShip.el.css({ left: Math.floor(newLeftPos), top: Math.floor(newTopPos) });
		    
		}, framerateInMSecs);


	</script>

</html>